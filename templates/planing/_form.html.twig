{# templates/form.html.twig #}

{# D√©but du formulaire #}

<div class="flex justify-center ">
    {{ form_start(form) }}

    <div id="step1" class="  bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 text-center">
        <h2 class="text-xl font-bold text-center m-2">√âtape 1: S√©lectionnez les dates</h2>

        {# Premi√®re √©tape: Champs startDate et endDate #}
        <div class="form-row">
            {{ form_label(form.startDate, 'Date de d√©but', {'label_attr': {'class': 'col-md-2 block mt-2 text-lg  '}}) }}
            <div class="col-md-10">
                {{ form_widget(form.startDate, {'attr': {'class': 'form-control'}, 'id': 'planing_startDate'}) }}
                {{ form_errors(form.startDate) }}
            </div>
        </div>

        <div class="form-row">
            {{ form_label(form.endDate, 'Date de fin', {'label_attr': {'class': 'col-md-2 block mt-2 text-lg '}}) }}
            <div class="col-md-10">
                {{ form_widget(form.endDate, {'attr': {'class': 'form-control'}, 'id': 'planing_endDate'}) }}
                {{ form_errors(form.endDate) }}
            </div>
        </div>

        <button type="button" id="nextStep1" class="bg-blue-400 py-2 px-4 rounded shadow m-4  hover:bg-blue-500" title="Page suivante">Suivant <i class="fa-solid fa-arrow-right"></i></button>
    </div>

    <div id="step2" style="display: none;">
        <h2 id="step2Title" class="text-xl font-bold text-center m-2">√âtape 2: Configuration du planning</h2>
        <p id="intervalDisplay" class="text-lg text-center mt-2"></p>

        {# Deuxi√®me √©tape: Les autres champs du formulaire #}
        <div id="dayWorksContainer" >
            {{ form_label(form.dayWorks) }}
            <div id="dayWorksList" data-prototype="{{ include('day_work/_form.html.twig', {'form': form.dayWorks.vars.prototype}) | e('html_attr') }}"></div>
            <button type="button" id="addDayWork" class="bg-blue-400 rounded shadow py-2 px-2 m-6" title="Ajouter une jour de travail"><i class="fa-solid fa-plus"></i> Ajouter un jour de travail</button>
        </div>

<div class=" flex justify-center">
        <button type="button" id="prevStep2" class="bg-blue-400 rounded shadow py-2 px-2 m-4 hover:bg-blue-500" title="Page prÈcÈdente"><i class="fa-solid fa-arrow-left"></i> Pr√©c√©dent</button>
        <button type="button" id="nextStep2" class="bg-blue-400 rounded shadow py-2 px-2 m-4 hover:bg-blue-500" title="Page suivante">Suivant <i class="fa-solid fa-arrow-right"></i></button>
</div>
    </div>

    <div id="step3" style="display: none;">
        <h2 class="text-xl font-bold text-center m-4">R√©capitulatif</h2>

        <p class="text-center font-lg">Date de d√©but s√©lectionn√©e: <span id="startDateDisplay" class="font-bold"></span></p>
        <p class="text-center font-lg">Date de fin s√©lectionn√©e: <span id="endDateDisplay" class="font-bold"></span></p>

        {# Troisi√®me √©tape: Autres champs du formulaire, si n√©cessaire #}
<divclass="flex justify-center">
        <button type="button" id="prevStep3" class="bg-blue-400 rounded shadow py-2 px-2 m-4 hover:bg-blue-500"title="Page prÈcÈdente"><i class="fa-solid fa-arrow-left"></i> Pr√©c√©dent</button>
        <button type="submit"  class="bg-teal-400 rounded shadow py-2 px-2 m-4 hover:bg-teal-500" title="CrÈer"><i class="fa-solid fa-check-to-slot"></i> Cr√©er</button>
</div>
    </div>

    {{ form_end(form) }}
</div>

{# Fin du formulaire #}

{# Inclure jQuery #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Obtenir la date actuelle au format ISO
        var now = new Date().toISOString().split("T")[0];

        // Pr√©remplir le champ de date de d√©but avec la date actuelle
        $('#planing_startDate').val(now);

        // D√©finir la date de fin comme un jour apr√®s la date de d√©but lors du chargement de la page
        var startDate = new Date($('#planing_startDate').val());
        var endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 1);
        $('#planing_endDate').val(endDate.toISOString().split("T")[0]);

        // G√©rer la navigation entre les √©tapes du formulaire
        $('#nextStep1').click(function() {
            var startDateString = $('#planing_startDate').val().trim();
            var endDateString = $('#planing_endDate').val().trim();
            if (!startDateString || !endDateString) {
                alert('Veuillez s√©lectionner les dates de d√©but et de fin.');
                return;
            }
            $('#step1').hide();
            $('#step2').show();
        });

        $('#prevStep2').click(function() {
            $('#step2').hide();
            $('#step1').show();
        });

        $('#nextStep2').click(function() {
            $('#step2').hide();
            $('#step3').show();
        });

        $('#prevStep3').click(function() {
            $('#step3').hide();
            $('#step2').show();
        });

        // Afficher les dates s√©lectionn√©es au format "jour/mois/ann√©e"
        $('#planing_startDate, #planing_endDate').change(function() {
            var startDate = new Date($('#planing_startDate').val());
            var endDate = new Date($('#planing_endDate').val());

            // V√©rifier si la date de fin est √©gale √† la date de d√©but
            if (endDate <= startDate) {
                // Si oui, d√©finir la date de fin comme un jour apr√®s la date de d√©but
                endDate.setDate(startDate.getDate() + 1);
                $('#planing_endDate').val(endDate.toISOString().split("T")[0]);
                alert("La date de fin doit √™tre ult√©rieure √† la date de d√©but. La date de fin a √©t√© ajust√©e.");
            }

            var startDateString = startDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
            var endDateString = endDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
            $('#startDateDisplay').text(startDateString);
            $('#endDateDisplay').text(endDateString);

            // Calculer le nombre de jours entre les deux dates
            var daysDifference = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));

            // Afficher l'intervalle choisi
            $('#intervalDisplay').text('Vous avez choisi de cr√©er un planning du ' + startDateString + ' au ' + endDateString);

            // Pr√©-remplir les champs de date de la collection dayWorks avec les dates correspondantes
            var dayWorksStartDate = new Date(startDate);
            var dayWorksList = $('#dayWorksList');
            dayWorksList.empty();
            for (var i = 0; i < daysDifference; i++) {
                var day = new Date(dayWorksStartDate);
                day.setDate(day.getDate() + i);
                var formattedDate = day.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
                var prototype = dayWorksList.attr('data-prototype').replace(/__name__/g, i);
                dayWorksList.append('<div><h2 class="text-lg font-bold mt-10 mb-4">' + formattedDate + '</h2>' + prototype + '</div>');
                var dateInput = $('#dayWorksList div:last-child input[type="date"]');
                dateInput.val(day.toISOString().split("T")[0]);
            }

            // Afficher ou cacher le bouton "Voir plus" en fonction du nombre de jours
            $('#showMore').toggle(daysDifference > 7);

            // Afficher 7 √©l√©ments de dayWorks par d√©faut
            $('#dayWorksList').children('div').slice(7).hide();

            // Afficher ou cacher le bouton "Voir moins" en fonction du nombre de jours initial
            $('#showLess').toggle(false);
        });

        // Emp√™cher la s√©lection de dates ant√©rieures √† la date actuelle
        $('#planing_startDate, #planing_endDate').on('change', function() {
            var selectedDate = new Date($(this).val());
            var currentDate = new Date(now);

            if (selectedDate < currentDate) {
                $(this).val(now);
            }
        });

        // G√©rer l'affichage de plus ou moins de 7 √©l√©ments de dayWorks
        $('#showMore').click(function() {
            $('#dayWorksList').children('div:hidden').slice(0, 7).show();
            $('#showLess').show();
            if ($('#dayWorksList').children('div:hidden').length === 0) {
                $(this).hide();
            }
        });

        $('#showLess').click(function() {
            $('#dayWorksList').children('div:visible').slice(-7).hide();
            $('#showMore').show();
            if ($('#dayWorksList').children('div:visible').length <= 7) {
                $(this).hide();
            }
        });

        // Ajouter un nouveau champ dayWork
        $('#addDayWork').click(function() {
            var dayWorksList = $('#dayWorksList');
            var prototype = dayWorksList.attr('data-prototype');
            var index = dayWorksList.children().length;
            var newForm = prototype.replace(/__name__/g, index);
            dayWorksList.append(newForm);
        });
    });
</script>
